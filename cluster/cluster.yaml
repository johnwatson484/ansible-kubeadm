- hosts: master
  become: yes
  tasks:
    - name: create nginx namespace
      become: yes
      become_user: ubuntu
      shell: kubectl get namespaces nginx || kubectl create namespace nginx

    - name: add stable helm repo
      become: yes
      become_user: ubuntu
      shell: helm repo add stable https://kubernetes-charts.storage.googleapis.com/

    - name: install nginx
      become: yes
      become_user: ubuntu
      shell: helm upgrade --install nginx stable/nginx-ingress --set controller.service.type=ClusterIP,controller.hostNetwork=true,controller.dnsPolicy=ClusterFirstWithHostNet,controller.kind=DaemonSet,controller.extraArgs.report-node-internal-ip-address=true --namespace nginx

    - name: create openvpn namespace
      become: yes
      become_user: ubuntu
      shell: kubectl get namespaces openvpn || kubectl create namespace openvpn

    - name: install openvpn
      become: yes
      become_user: ubuntu
      shell: helm upgrade --install openvpn stable/openvpn --set persistence.enabled=false,service.type=NodePort,openvpn.keystoreSecret=openvpn-keystore-secret --namespace openvpn

    - name: create cert-manager namespace
      become: yes
      become_user: ubuntu
      shell: kubectl get namespaces cert-manager || kubectl create namespace cert-manager

    - name: install cert-manager
      become: yes
      become_user: ubuntu
      shell: kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v0.12.0/cert-manager.yaml
